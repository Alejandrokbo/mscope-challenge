@startuml modelo-datos-multitenant
!theme plain
skinparam backgroundColor white
skinparam defaultFontName Arial
title Modelo de Datos Multitenant - Esquema Detallado

' Estilo de entidades
skinparam class {
    BackgroundColor #E8F4F8
    BorderColor #2C5AA0
    ArrowColor #5D8BC7
    FontSize 11
}

entity tenants {
  * **tenant_id** : UUID <<PK>>
  ==
  * country_code : VARCHAR(2)
  * name : VARCHAR(100)
  * status : ENUM('active','suspended','deleted')
  * created_at : TIMESTAMP
  * updated_at : TIMESTAMP
  --
  config : JSONB
  metadata : JSONB
}

entity users {
  * **user_id** : UUID <<PK>>
  * **tenant_id** : UUID <<FK>>
  ==
  * email : VARCHAR(255)
  * password_hash : VARCHAR(255)
  first_name : VARCHAR(100)
  last_name : VARCHAR(100)
  phone : VARCHAR(20)
  * status : ENUM('active','inactive','blocked')
  * created_at : TIMESTAMP
  updated_at : TIMESTAMP
  last_login : TIMESTAMP
  --
  preferences : JSONB
}

entity accounts {
  * **account_id** : UUID <<PK>>
  * **tenant_id** : UUID <<FK>>
  * **user_id** : UUID <<FK>>
  ==
  * account_number : VARCHAR(20)
  * account_type : ENUM('checking','savings','investment')
  * currency : VARCHAR(3)
  balance : DECIMAL(15,2)
  available_balance : DECIMAL(15,2)
  * status : ENUM('active','frozen','closed')
  * created_at : TIMESTAMP
  updated_at : TIMESTAMP
}

entity transactions {
  * **transaction_id** : UUID <<PK>>
  * **tenant_id** : UUID <<FK>>
  * **account_id** : UUID <<FK>>
  ==
  * amount : DECIMAL(15,2)
  * currency : VARCHAR(3)
  * type : ENUM('debit','credit','transfer')
  * status : ENUM('pending','completed','failed','reversed')
  * created_at : TIMESTAMP
  completed_at : TIMESTAMP
  --
  description : VARCHAR(500)
  reference : VARCHAR(100)
  fraud_score : DECIMAL(3,2)
  fraud_checked : BOOLEAN
  metadata : JSONB
}

entity audit_logs {
  * **log_id** : UUID <<PK>>
  * **tenant_id** : UUID <<FK>>
  ==
  * entity_type : VARCHAR(50)
  * entity_id : UUID
  * action : ENUM('create','update','delete','login')
  * user_id : UUID
  * created_at : TIMESTAMP
  --
  ip_address : VARCHAR(45)
  user_agent : TEXT
  changes : JSONB
}

' Relaciones
tenants ||--o{ users : "has many"
tenants ||--o{ accounts : "has many"
tenants ||--o{ transactions : "has many"
tenants ||--o{ audit_logs : "has many"
users ||--o{ accounts : "owns"
accounts ||--o{ transactions : "has many"

note right of tenants
  **Config JSONB incluye:**
  - Configuración regional
  - Feature flags
  - Límites operativos
  - Integraciones
end note

note right of transactions
  **fraud_score:**
  Calculado por ML model
  >0.6 = Alto riesgo
  Requiere revisión manual
end note

note bottom of audit_logs
  **Tabla de auditoría:**
  Cumplimiento GDPR/regulatorio
  Trazabilidad completa
  Retención: 7 años
end note

@enduml
